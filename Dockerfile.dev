# 本番環境用Dockerfile
FROM node:22-alpine

WORKDIR /app

# 依存関係をコピーしてインストール
COPY package.json package-lock.json ./
RUN npm ci

# アプリケーションコードをコピー
COPY . .

# ビルド時の環境変数（ダミー）
ARG DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy

# Prisma生成とビルド
RUN npx prisma generate
RUN npm run build

EXPOSE 3000

# 本番サーバー起動スクリプト（マイグレーションも含む）
CMD ["sh", "-c", "npx prisma migrate deploy && npm run start"]
